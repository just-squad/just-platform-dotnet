name: main branch

on:
  push:
    branches: [ main ]

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semantic_release.outputs.version }}
      released: ${{ steps.semantic_release.outputs.released }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js for semantic-release
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install semantic-release plugins
      run: |
        npm install --save-dev \
          semantic-release \
          @semantic-release/github \
          @semantic-release/exec

    - name: Run semantic-release
      id: semantic_release
      run: |
        npx semantic-release --dry-run
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release --no-restore
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Restore dependencies
        run: dotnet restore
      - name: Run tests
        run: dotnet test --configuration Release --no-build --verbosity normal


  publish:
    needs: [build, tests, release]
    runs-on: ubuntu-latest
    if: needs.release.outputs.released == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and pack with version from tag
      run: |
        TAG_VERSION="${{ needs.release.outputs.version }}"
        echo "Building with version: $TAG_VERSION"
        dotnet build --configuration Release --no-restore /p:Version=$TAG_VERSION
        dotnet pack --configuration Release --no-build --output ./nupkgs /p:Version=$TAG_VERSION

    - name: Publish to NuGet
      run: |
        for package in ./nupkgs/*.nupkg; do
          if [ -f "$package" ]; then
            dotnet nuget push "$package" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          fi
        done